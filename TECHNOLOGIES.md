# Easy Stat R 技術仕様

## 1. 概要

Easy Stat Rは、ブラウザ上で動作するインタラクティブな統計分析アプリケーションです。ユーザーはCSVやExcelファイルをアップロードし、探索的データ分析（EDA）、t検定、相関分析など、さまざまな統計手法を直感的なUIで実行できます。

このアプリケーションの主な目的は、高価な統計ソフトウェアを必要とせず、誰でも手軽に高度なデータ分析を行える環境を提供することです。特に、教育や研究分野での利用を想定しています。

## 2. 技術スタック

本アプリケーションは、最新のWeb技術を駆使して構築されています。

- **フロントエンド**:
    - **言語**: [Rust](https://www.rust-lang.org/)
    - **フレームワーク**: [Leptos](https://leptos.dev/) (v0.6)
    - **コンパイルターゲット**: WebAssembly (WASM)
- **データ処理**:
    - **ライブラリ**: [Polars](https://pola.rs/) (v0.41)
- **ビルドツール**:
    - [Trunk](https://trunkrs.dev/)
- **デプロイメント**:
    - GitHub Pages

### 2.1. Rust と WebAssembly

アプリケーションのコアロジックはRustで記述されています。Rustは、その安全性、パフォーマンス、並行性の高さから、複雑な計算処理が求められる統計分析アプリケーションに最適です。

コードはWebAssembly（WASM）にコンパイルされ、ブラウザ上でネイティブに近い速度で実行されます。これにより、大規模なデータセットでもスムーズなユーザー体験を実現しています。

### 2.2. Leptos フレームワーク

UIの構築には、リアクティブなWebアプリケーションを構築するためのRust製フレームワークであるLeptosを使用しています。Leptosは、コンポーネントベースのアーキテクチャ、きめ細やかなリアクティビティ、そしてサーバーサイドレンダリング（SSR）とクライアントサイドレンダリング（CSR）の両方をサポートする柔軟性を特徴としています。本アプリケーションでは、GitHub Pagesでのホスティングのため、CSR（Client-Side Rendering）モードで動作させています。

### 2.3. Polars ライブラリ

データ操作と分析の中核を担うのが、Rust製の超高速データフレームライブラリであるPolarsです。Polarsは、Apache Arrow形式をメモリモデルとして採用し、効率的なクエリ実行とメモリ管理を実現します。

本アプリケーションでは、以下のPolarsの機能を活用しています。

- **ファイル読み込み**: CSV、Excelファイルのパース
- **データ操作**: フィルタリング、ソート、集計
- **統計計算**: 平均、標準偏差、最小値、最大値など

WASM環境での制約により、一部の機能（例: `describe`メソッド）が利用できないため、必要な統計量は手動で計算するなどの対応を行っています。

## 3. 機能実装の詳細

### 3.1. ファイルアップロード

ユーザーは、ドラッグ＆ドロップまたはファイル選択ダイアログを通じて、ローカルのCSVまたはExcelファイルをアップロードできます。

- **実装**: `src/components/file_upload.rs`
- **処理フロー**:
    1. HTMLの`<input type="file">`要素でファイルが選択されると、`on:change`イベントが発火します。
    2. JavaScriptの`FileReader` APIをWebAssemblyから利用し、ファイルの内容をバイナリデータ（`Uint8Array`）として読み込みます。
    3. ファイルの拡張子に応じて、`polars`（CSVの場合）または`calamine`（Excelの場合）ライブラリを使用してバイナリデータをPolarsのDataFrameに変換します。
    4. 変換されたDataFrameは、Leptosのリアクティブな状態管理システム（`AppData`）に格納され、アプリケーション全体で共有されます。

### 3.2. 探索的データ分析 (EDA)

アップロードされたデータの概要を把握するための機能です。

- **実装**: `src/pages/eda.rs`
- **表示内容**:
    - **データフレーム**: アップロードされたデータの最初の数行を表示します。
    - **要約統計量**: 各列の以下の基本統計量を計算し、テーブル形式で表示します。
        - `count`: データ数
        - `mean`: 平均値
        - `std`: 標準偏差
        - `min`: 最小値
        - `max`: 最大値
- **実装詳細**:
    - 当初、Polarsの`describe`メソッドの利用を試みましたが、WASMビルドではサポートされていないことが判明しました。
    - そのため、`calculate_summary`関数を独自に実装し、各列のデータ型を判定しながら統計量を手動で計算しています。数値以外の列については、統計量の計算はスキップされます。

### 3.3. その他の分析機能

本アプリケーションには、EDA以外にも以下の統計分析機能が実装されています。これらの機能も同様に、Leptosのコンポーネントとして`src/pages/`ディレクトリ内に実装されています。

- **t検定**: `t_test_unified.rs`
- **カイ二乗検定**: `chi_square.rs`
- **相関分析**: `correlation.rs`
- **回帰分析**: `regression.rs`
- **主成分分析 (PCA)**: `pca.rs`
- **因子分析**: `factor_analysis.rs`
- **テキストマイニング**: `text_mining.rs`

これらの各機能は、`AppData`からDataFrameを読み込み、それぞれの統計ロジックを適用し、結果をインタラクティブに表示します。

## 4. 言語設定

- **UI**: アプリケーションのUIは、ユーザーの利便性を考慮し、全面的に**日本語**で表示されます。
- **コード**: ソースコード内のコメントやドキュメントは、主に英語で記述されていますが、UIに表示される文字列は日本語です。

## 5. 開発から得られた教訓

今回の開発プロセスでは、特にRustとWebAssemblyの組み合わせにおけるいくつかの重要な知見を得ました。

### 5.1. 環境設定の重要性

開発初期段階で、`cargo`や`trunk`といった基本的なツールが実行パスに含まれていない問題に直面しました。これは、開発環境のセットアップが不完全であったことが原因です。

- **教訓**: 新しいプロジェクトを開始する際は、まず`rustup`や`cargo`のインストール状況、そして`PATH`環境変数の設定を確実に確認することが不可欠です。`source $HOME/.cargo/env`コマンドなどを実行し、シェル環境を正しく設定することで、その後のビルドプロセスをスムーズに進めることができます。

### 5.2. PolarsライブラリのWASM環境における制約

要約統計量を表示する機能の実装において、Polarsの`describe`メソッドがWASMビルドでは利用できないという問題が発生しました。`Cargo.toml`で`describe`フィーチャーを有効にしても、コンパイルエラーは解決しませんでした。

- **教訓**: WebAssembly環境でRustのライブラリを利用する際は、公式ドキュメントでWASMサポートの範囲や制約を事前に確認することが非常に重要です。特に、`default-features = false`のような設定で機能を細かく制御する場合、意図した機能がWASMターゲットで有効になっているかを注意深く検証する必要があります。すべての機能がWASMで動作するとは限らないため、代替案（今回は統計量の手動計算）を検討する柔軟性が求められます。

### 5.3. Rustの型システムとの対話

`describe`メソッドの代替として統計量を手動で計算する過程で、Rustの厳格な型システムに起因する多くの型不一致エラーに直面しました。特に、Polarsの`Series`が保持する様々なデータ型（`f32`, `f64`, `i32`, `i64`など）を統一的に処理する際に困難が伴いました。

- **解決策**: 最終的に、`series.to_physical_repr().cast(&DataType::Float64)`というアプローチを採用しました。これにより、数値型の列を一度物理的な表現に変換し、その後`f64`型に安全にキャストすることで、データ型を統一して統計計算を行うことができました。
- **教訓**: Rustのコンパイラは非常に厳格ですが、そのエラーメッセージは問題解決のための重要なヒントを与えてくれます。型エラーに直面した際は、`match`文によるデータ型ごとの分岐や、ライブラリが提供する型変換メソッド（`cast`, `to_physical_repr`など）を適切に活用することで、堅牢で安全なコードを記述できることを再認識しました。

## 6. 今後の展望

- **インタラクティブなグラフ描画**: `plotly`クレートを活用し、分析結果を視覚的に表現するグラフ描画機能を追加します。
- **分析機能の拡充**: 分散分析（ANOVA）のバリエーション追加や、より高度な多変量解析手法を実装します。
- **パフォーマンス最適化**: より大規模なデータセットに対応できるよう、WASMのメモリ管理やPolarsのクエリをさらに最適化します。
- **状態管理の永続化**: 分析途中の状態をブラウザのローカルストレージに保存し、後で再開できる機能を追加します。